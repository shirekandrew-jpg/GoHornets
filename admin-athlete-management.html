<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Athlete Management - Go Hornets</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@sendgrid/mail@7.7.0/lib/mail.min.js"></script>
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    .back-button {
      padding: 12px 24px;
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 8px;
      color: #d4af37;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .back-button:hover {
      background: rgba(212, 175, 55, 0.2);
      transform: translateY(-2px);
    }

    .add-athlete-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #22c55e 0%, #d4af37 100%);
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-athlete-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .athlete-table {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(212, 175, 55, 0.2);
      overflow-x: auto;
    }

    .athlete-table h2 {
      color: #d4af37;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(0, 0, 0, 0.3);
    }

    th {
      padding: 15px;
      text-align: left;
      color: #d4af37;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 1px;
    }

    td {
      padding: 15px;
      color: #fff;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    tr:hover {
      background: rgba(212, 175, 55, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-invited {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .status-active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .status-pending {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .action-btn {
      padding: 6px 12px;
      margin: 0 4px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-invite {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .btn-invite:hover {
      background: rgba(34, 197, 94, 0.3);
    }

    .btn-copy {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .btn-copy:hover {
      background: rgba(59, 130, 246, 0.3);
    }

    .btn-delete {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .modal.visible {
      display: flex;
    }

    .modal-content {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      padding: 40px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .modal-header {
      color: #d4af37;
      margin-bottom: 30px;
      font-size: 1.8em;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #d4af37;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(212, 175, 55, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      font-family: 'Inter', sans-serif;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #d4af37;
      background: rgba(0, 0, 0, 0.5);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e 0%, #d4af37 100%);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .invite-link-box {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, 0.3);
      margin-top: 15px;
      word-break: break-all;
      font-family: monospace;
      color: #22c55e;
    }
  </style>
</head>
<body>
  <script src="auth.js"></script>
  <script>
    // Require admin authentication
    if (!requireAthleteAuth()) {
      // Will redirect to login
    } else {
      const session = getAthleteSession();
      if (!session.isAdmin) {
        alert('Access denied. Admin privileges required.');
        window.location.href = 'dashboard.html';
      }
    }
  </script>

  <div class="admin-container">
    <div class="top-controls">
      <a href="dashboard.html" class="back-button">‚Üê Back to Dashboard</a>
      <button class="add-athlete-btn" onclick="showAddModal()">+ Add Athlete</button>
    </div>

    <div class="athlete-table">
      <h2>üêù Athlete Portal Access</h2>
      <div id="loading" class="loading">Loading athletes from Perch API...</div>
      <table id="athleteTable" style="display: none;">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="athleteTableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit Athlete Modal -->
  <div class="modal" id="athleteModal">
    <div class="modal-content">
      <h2 class="modal-header" id="modalTitle">Add Athlete</h2>
      <form id="athleteForm">
        <div class="form-group">
          <label>Select Athlete from Perch</label>
          <select id="perchAthleteSelect" required>
            <option value="">-- Select an athlete --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="athleteEmail" required placeholder="athlete@email.com">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="isAdmin" style="width: auto; margin-right: 10px;">
            Grant Admin Access (can view all athletes)
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="modal-btn btn-secondary" onclick="hideModal()">Cancel</button>
          <button type="submit" class="modal-btn btn-primary">Save & Generate Invite</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invite Link Modal -->
  <div class="modal" id="inviteLinkModal">
    <div class="modal-content">
      <h2 class="modal-header">üìß Invite Link Generated</h2>
      <p style="color: #888; margin-bottom: 20px;">Send this link to the athlete to set up their account:</p>
      <div class="invite-link-box" id="inviteLinkText"></div>
      <div class="modal-actions">
        <button type="button" class="modal-btn btn-secondary" onclick="hideInviteModal()">Close</button>
        <button type="button" class="modal-btn btn-primary" onclick="copyInviteLink()">Copy Link</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const API_BASE = 'https://api.perch.fit/v2';
    const ORG_ID = 7617;
    const TOKEN = '31606b711ce9ef5a7b7d887dcbe60c6601f6691d7d3b9bab3f0eeb0ab9db';
    const SENDGRID_API_KEY = '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';
    const FROM_EMAIL = 'aespinoza@savcds.org'; // Your verified sender email
    const FROM_NAME = 'Hornet Athletics Portal';

    let perchAthletes = [];
    let athleteCredentials = [];
    let currentInviteLink = '';

    // Load on page load
    document.addEventListener('DOMContentLoaded', async () => {
      await loadPerchAthletes();
      loadAthleteCredentials();
      renderTable();
    });

    async function loadPerchAthletes() {
      try {
        let allUsers = [];
        let nextToken = null;
        let hasMore = true;

        console.log('Starting to load athletes from Perch...');

        while (hasMore) {
          const body = {
            limit: 500,
            group_id: ORG_ID,
            active: true
          };

          if (nextToken) body.next_token = nextToken;

          console.log('Fetching users with body:', body);

          const response = await fetch(`${API_BASE}/users`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${TOKEN}`,
              'Content-Type': 'application/json',
              'accept': 'application/json'
            },
            body: JSON.stringify(body)
          });

          console.log('Response status:', response.status);

          if (!response.ok) {
            console.error('Failed to fetch users, status:', response.status);
            break;
          }

          const data = await response.json();
          console.log('Received data:', data);
          allUsers = allUsers.concat(data.data || []);

          if (data.truncated && data.next_token) {
            nextToken = data.next_token;
          } else {
            hasMore = false;
          }
        }

        console.log('Total athletes loaded:', allUsers.length);

        perchAthletes = allUsers.sort((a, b) => {
          const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
          const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
          return nameA.localeCompare(nameB);
        });

        populatePerchSelect();
      } catch (error) {
        console.error('Error loading Perch athletes:', error);
        alert('Error loading athletes from Perch API. Check console for details.');
      }
    }

    function populatePerchSelect() {
      const select = document.getElementById('perchAthleteSelect');
      select.innerHTML = '<option value="">-- Select an athlete --</option>';
      
      perchAthletes.forEach(athlete => {
        const option = document.createElement('option');
        option.value = athlete.id;
        option.textContent = `${athlete.first_name} ${athlete.last_name}`;
        option.dataset.firstName = athlete.first_name;
        option.dataset.lastName = athlete.last_name;
        select.appendChild(option);
      });
    }

    function loadAthleteCredentials() {
      const stored = localStorage.getItem('athlete_credentials');
      athleteCredentials = stored ? JSON.parse(stored) : [];
    }

    function saveAthleteCredentials() {
      localStorage.setItem('athlete_credentials', JSON.stringify(athleteCredentials));
    }

    function renderTable() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('athleteTable').style.display = 'table';

      const tbody = document.getElementById('athleteTableBody');
      tbody.innerHTML = '';

      if (athleteCredentials.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #888; padding: 40px;">No athletes added yet. Click "Add Athlete" to get started.</td></tr>';
        return;
      }

      athleteCredentials.forEach((athlete, index) => {
        const tr = document.createElement('tr');
        
        const status = athlete.passwordHash ? 'active' : 'pending';
        const statusText = athlete.passwordHash ? 'Active' : 'Pending Setup';
        const adminBadge = athlete.admin ? '<span class="status-badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; margin-left: 8px;">ADMIN</span>' : '';
        
        tr.innerHTML = `
          <td>${athlete.firstName} ${athlete.lastName}${adminBadge}</td>
          <td>${athlete.email}</td>
          <td><span class="status-badge status-${status}">${statusText}</span></td>
          <td>
            ${!athlete.passwordHash ? `<button class="action-btn btn-invite" onclick="resendInvite(${index})">üìß Send Invite</button>` : ''}
            ${!athlete.passwordHash ? `<button class="action-btn" onclick="markAsActive(${index})" style="background: #22c55e;">‚úì Mark Active</button>` : ''}
            <button class="action-btn btn-copy" onclick="copyInviteLink(${index})">üîó Copy Link</button>
            <button class="action-btn btn-delete" onclick="deleteAthlete(${index})">üóëÔ∏è Delete</button>
          </td>
        `;
        
        tbody.appendChild(tr);
      });
    }

    function showAddModal() {
      document.getElementById('athleteModal').classList.add('visible');
      document.getElementById('athleteForm').reset();
    }

    function hideModal() {
      document.getElementById('athleteModal').classList.remove('visible');
    }

    function hideInviteModal() {
      document.getElementById('inviteLinkModal').classList.remove('visible');
    }

    document.getElementById('athleteForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const select = document.getElementById('perchAthleteSelect');
      const selectedOption = select.options[select.selectedIndex];
      const athleteId = select.value;
      const email = document.getElementById('athleteEmail').value;
      const isAdmin = document.getElementById('isAdmin').checked;

      if (!athleteId || !email) {
        alert('Please select an athlete and enter an email');
        return;
      }

      const inviteToken = generateInviteToken();
      
      const newAthlete = {
        id: parseInt(athleteId),
        firstName: selectedOption.dataset.firstName,
        lastName: selectedOption.dataset.lastName,
        email: email,
        passwordHash: null,
        inviteToken: inviteToken,
        admin: isAdmin,
        createdAt: Date.now()
      };

      athleteCredentials.push(newAthlete);
      saveAthleteCredentials();
      renderTable();
      hideModal();

      // Show invite link and send email
      // Encode athlete data in URL so it works on any computer
      const athleteData = btoa(JSON.stringify({
        id: newAthlete.id,
        firstName: newAthlete.firstName,
        lastName: newAthlete.lastName,
        email: newAthlete.email,
        admin: newAthlete.admin,
        token: inviteToken
      }));
      const inviteLink = `${CONFIG.getBaseURL()}/athlete-setup.html?data=${athleteData}`;
      currentInviteLink = inviteLink;
      
      // Send email automatically (no modal popup)
      sendInviteEmail(email, newAthlete.firstName, newAthlete.lastName, inviteLink);
    });

    function generateInviteToken() {
      return Array.from(crypto.getRandomValues(new Uint8Array(32)))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    function resendInvite(index) {
      const athlete = athleteCredentials[index];
      const athleteData = btoa(JSON.stringify({
        id: athlete.id,
        firstName: athlete.firstName,
        lastName: athlete.lastName,
        email: athlete.email,
        admin: athlete.admin,
        token: athlete.inviteToken
      }));
      const inviteLink = `${CONFIG.getBaseURL()}/athlete-setup.html?data=${athleteData}`;
      currentInviteLink = inviteLink;
      document.getElementById('inviteLinkText').textContent = inviteLink;
      document.getElementById('inviteLinkModal').classList.add('visible');
      
      // Send email
      sendInviteEmail(athlete.email, athlete.firstName, athlete.lastName, inviteLink);
    }

    async function sendInviteEmail(email, firstName, lastName, inviteLink) {
      try {
        const emailServerURL = CONFIG.getEmailServerURL();
        
        // Try to send via serverless function (works in both local and production)
        if (emailServerURL) {
          const response = await fetch(emailServerURL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              email,
              firstName,
              lastName,
              inviteLink
            })
          });

          const result = await response.json();

          if (result.success) {
            alert(`‚úÖ Invite email sent successfully to ${firstName} ${lastName} at ${email}!`);
            console.log('Email sent successfully');
            return;
          } else {
            console.error('Email API error:', result.error);
            throw new Error(result.error || 'Email API failed');
          }
        }
        
        // No email server configured
        throw new Error('No email server configured');
        
      } catch (error) {
        console.log('Email send failed, using mailto fallback:', error.message);
        // Fallback to mailto
        const subject = encodeURIComponent('Invitation to Hornet Athletics Portal');
        const body = encodeURIComponent(
          `Hi ${firstName},\n\n` +
          `You've been invited to access the Hornet Athletics Portal!\n\n` +
          `Click the link below to set up your account:\n` +
          `${inviteLink}\n\n` +
          `This link is unique to you and can only be used once.\n\n` +
          `Best regards,\n` +
          `Hornet Athletics Team`
        );
        
        window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_blank');
        alert(`üìß Email client opened. Please click Send to deliver the invite.`);
      }
    }

    function copyInviteLink(index) {
      const athlete = athleteCredentials[index];
      const athleteData = btoa(JSON.stringify({
        id: athlete.id,
        firstName: athlete.firstName,
        lastName: athlete.lastName,
        email: athlete.email,
        admin: athlete.admin,
        token: athlete.inviteToken
      }));
      const inviteLink = `${CONFIG.getBaseURL()}/athlete-setup.html?data=${athleteData}`;
      
      navigator.clipboard.writeText(inviteLink).then(() => {
        alert('Invite link copied to clipboard!');
      }).catch(() => {
        prompt('Copy this link:', inviteLink);
      });
    }

    function markAsActive(index) {
      if (confirm('Confirm this athlete has completed their account setup?')) {
        // Mark as active with a placeholder password hash
        athleteCredentials[index].passwordHash = 'SETUP_COMPLETED';
        athleteCredentials[index].setupCompletedAt = Date.now();
        saveAthleteCredentials();
        renderTable();
        alert('‚úì Athlete marked as active!');
      }
    }

    function deleteAthlete(index) {
      if (confirm('Are you sure you want to delete this athlete\'s portal access?')) {
        athleteCredentials.splice(index, 1);
        saveAthleteCredentials();
        renderTable();
      }
    }
  </script>
</body>
</html>
