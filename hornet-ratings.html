<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hornet Ratings</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Rating card styling */
    .ratings-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .athlete-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .athlete-dropdown {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--hornet-green);
      background: white;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      min-width: 200px;
    }

    .gender-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .gender-tab {
      padding: 0.75rem 2rem;
      border-radius: 12px;
      border: 2px solid var(--hornet-green);
      background: transparent;
      color: var(--hornet-green);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .gender-tab.active {
      background: var(--hornet-green);
      color: var(--hornet-gold);
    }

    .rating-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .rating-card {
      background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-light);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .rating-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    }

    .rating-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .rating-icon {
      font-size: 2rem;
      margin-right: 1rem;
    }

    .rating-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--hornet-green);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .rating-score {
      font-size: 3rem;
      font-weight: 800;
      color: var(--hornet-green);
      margin: 1rem 0;
      text-align: center;
    }

    .rating-bar {
      width: 100%;
      height: 12px;
      background: #e9ecef;
      border-radius: 6px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .rating-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--hornet-green) 0%, var(--hornet-gold) 100%);
      border-radius: 6px;
      transition: width 0.8s ease;
    }

    .rating-details {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-align: center;
      margin-top: 1rem;
    }

    .overall-rating {
      background: linear-gradient(135deg, var(--hornet-green) 0%, var(--hornet-green-light) 100%);
      color: white;
      padding: 3rem 2rem;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 3rem;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    }

    .overall-score {
      font-size: 4rem;
      font-weight: 900;
      margin-bottom: 1rem;
    }

    .overall-title {
      font-size: 1.5rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .error {
      text-align: center;
      padding: 2rem;
      color: #dc3545;
      background: #f8d7da;
      border-radius: 12px;
      margin: 1rem 0;
    }

    .back-button {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 2px solid var(--hornet-green);
      background: transparent;
      color: var(--hornet-green);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 2rem;
    }

    .back-button:hover {
      background: var(--hornet-green);
      color: var(--hornet-gold);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .ratings-container {
        padding: 1rem;
      }

      .rating-cards {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .athlete-selector {
        flex-direction: column;
        align-items: center;
      }

      .overall-score {
        font-size: 3rem;
      }
    }
  </style>
</head>

<body>
  <main class="main-content">
    <div class="ratings-container">
      <!-- Top Controls -->
      <button class="back-button" onclick="navigateWithHornets('index.html')">
        ‚Üê Back to Home
      </button>

      <!-- Gender Selection -->
      <div class="gender-selector">
        <button class="gender-tab active" data-gender="male" onclick="switchGender('male')">
          Male Athletes
        </button>
        <button class="gender-tab" data-gender="female" onclick="switchGender('female')">
          Female Athletes
        </button>
      </div>

      <!-- Athlete Selection -->
      <div class="athlete-selector">
        <select class="athlete-dropdown" id="athleteSelector" onchange="selectAthlete()">
          <option value="">Select an athlete...</option>
        </select>
      </div>

      <!-- Loading/Error States -->
      <div id="loadingState" class="loading">Loading athletes and calculating ratings...</div>
      <div id="errorState" class="error" style="display: none;"></div>

      <!-- Rating Display -->
      <div id="ratingDisplay" style="display: none;">
        <!-- Overall Rating -->
        <div class="overall-rating">
          <div class="overall-score" id="overallScore">--</div>
          <div class="overall-title">Overall Hornet Rating</div>
        </div>

        <!-- Individual Rating Cards -->
        <div class="rating-cards">
          <!-- Lower Body Strength -->
          <div class="rating-card">
            <div class="rating-header">
              <span class="rating-icon">ü¶µ</span>
              <h3 class="rating-title">Lower Body Strength</h3>
            </div>
            <div class="rating-score" id="lowerStrengthScore">--</div>
            <div class="rating-bar">
              <div class="rating-fill" id="lowerStrengthBar" style="width: 0%"></div>
            </div>
            <div class="rating-details" id="lowerStrengthDetails">Based on best weight from squats and deadlifts</div>
          </div>

          <!-- Lower Body Power -->
          <div class="rating-card">
            <div class="rating-header">
              <span class="rating-icon">‚ö°</span>
              <h3 class="rating-title">Lower Body Power</h3>
            </div>
            <div class="rating-score" id="lowerPowerScore">--</div>
            <div class="rating-bar">
              <div class="rating-fill" id="lowerPowerBar" style="width: 0%"></div>
            </div>
            <div class="rating-details" id="lowerPowerDetails">Based on best power from jumps and lifts</div>
          </div>

          <!-- Upper Body Strength -->
          <div class="rating-card">
            <div class="rating-header">
              <span class="rating-icon">üí™</span>
              <h3 class="rating-title">Upper Body Strength</h3>
            </div>
            <div class="rating-score" id="upperStrengthScore">--</div>
            <div class="rating-bar">
              <div class="rating-fill" id="upperStrengthBar" style="width: 0%"></div>
            </div>
            <div class="rating-details" id="upperStrengthDetails">Based on best weight from bench press</div>
          </div>

          <!-- Upper Body Power -->
          <div class="rating-card">
            <div class="rating-header">
              <span class="rating-icon">üöÄ</span>
              <h3 class="rating-title">Upper Body Power</h3>
            </div>
            <div class="rating-score" id="upperPowerScore">--</div>
            <div class="rating-bar">
              <div class="rating-fill" id="upperPowerBar" style="width: 0%"></div>
            </div>
            <div class="rating-details" id="upperPowerDetails">Based on best power from bench press</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Hornet Animation Container -->
  <div id="hornetContainer" class="hornet-container"></div>

  <script>
    // Hornet animation functions (copied from index.html)
    function navigateWithHornets(url) {
      if (url === '#') return;
      
      createHornetSwarm();
      
      setTimeout(() => {
        window.location.href = url;
      }, 1200);
    }

    function createHornetSwarm() {
      const container = document.getElementById('hornetContainer');
      container.innerHTML = '';
      
      for (let i = 0; i < 20; i++) {
        const hornet = document.createElement('div');
        hornet.className = 'hornet';
        
        hornet.innerHTML = `
          <div style="
            position: relative;
            width: 24px;
            height: 12px;
            background: linear-gradient(90deg, #1a1a1a 0%, #8b4513 20%, #ffd700 40%, #1a1a1a 60%, #8b4513 80%, #ffd700 100%);
            border-radius: 60% 40%;
            box-shadow: 
              0 0 4px rgba(255, 215, 0, 0.8),
              inset 0 1px 0 rgba(255, 255, 255, 0.4),
              inset 0 -1px 0 rgba(0, 0, 0, 0.3);
          ">
            <div style="
              position: absolute;
              top: -2px;
              left: 8px;
              width: 12px;
              height: 8px;
              background: radial-gradient(ellipse, rgba(255, 255, 255, 0.6) 0%, rgba(200, 220, 255, 0.3) 70%, transparent 100%);
              border-radius: 80% 20%;
              animation: wingFlap 0.08s infinite alternate;
              transform-origin: 20% 50%;
            "></div>
            <div style="
              position: absolute;
              top: -2px;
              left: 4px;
              width: 12px;
              height: 8px;
              background: radial-gradient(ellipse, rgba(255, 255, 255, 0.6) 0%, rgba(200, 220, 255, 0.3) 70%, transparent 100%);
              border-radius: 80% 20%;
              animation: wingFlap 0.08s infinite alternate-reverse;
              transform-origin: 80% 50%;
            "></div>
            <div style="
              position: absolute;
              top: 2px;
              left: 2px;
              width: 4px;
              height: 4px;
              background: #1a1a1a;
              border-radius: 50%;
              box-shadow: 8px 0 0 #1a1a1a;
            "></div>
          </div>
        `;
        
        const startY = Math.random() * window.innerHeight;
        const startX = -150;
        const duration = 3 + Math.random() * 3;
        const delay = Math.random() * 2;
        const size = 0.8 + Math.random() * 0.6;
        
        hornet.style.cssText = `
          position: fixed;
          left: ${startX}px;
          top: ${startY}px;
          z-index: 9999;
          pointer-events: none;
          animation: flyAcross ${duration}s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${delay}s forwards;
          transform-origin: center;
          transform: scale(${size});
          filter: drop-shadow(2px 2px 6px rgba(0, 0, 0, 0.4));
        `;
        
        container.appendChild(hornet);
        
        setTimeout(() => {
          if (hornet.parentNode) {
            hornet.parentNode.removeChild(hornet);
          }
        }, (duration + delay + 1) * 1000);
      }
    }

    // Hornet Rating System Implementation
    const AUTH_HEADER = 'Bearer 31606b711ce9ef5a7b7d887dcbe60c6601f6691d7d3b9bab3f0eeb0ab9db';
    const ORG_ID = 7617;
    
    let allUsers = [];
    let allExercises = [];
    let allSets = [];
    let allRatings = {};
    let currentGender = 'male';
    let selectedAthlete = null;

    // Exercise mapping based on your requirements
    const EXERCISE_CONFIG = {
      'Back Squat': { body_segment: 'LOWER', movement_pattern: 'SQUAT' },
      'Front Squat': { body_segment: 'LOWER', movement_pattern: 'SQUAT' },
      'Trap Bar Deadlift': { body_segment: 'LOWER', movement_pattern: 'DEADLIFT' },
      'Trap Bar Jump': { body_segment: 'LOWER', movement_pattern: 'JUMP' },
      'Bench Press': { body_segment: 'UPPER', movement_pattern: 'PRESS' }
    };

    // Unit conversion constants
    const M_PER_IN = 0.0254;
    const KG_PER_LBS = 0.453592;
    const N_PER_LBS = 4.44822;

    // Convert mean power from (in * lbs / s) to watts
    function convertMeanPowerToWatts(meanPowerInLbsInS) {
      if (meanPowerInLbsInS == null) return null;
      return M_PER_IN * N_PER_LBS * meanPowerInLbsInS;
    }

    // Convert peak power from (in^2 * lbs) / sec^3 to watts
    function convertPeakPowerToWatts(peakPowerPerMassZ, weightLbs) {
      if (peakPowerPerMassZ == null || weightLbs == null) return null;
      return (M_PER_IN * M_PER_IN) * KG_PER_LBS * peakPowerPerMassZ * weightLbs;
    }

    // Filter out ghost reps from a set's reps array
    function getValidReps(set) {
      if (!set.reps || set.reps.length === 0) return [];
      
      // If there are ghost rep indices, filter them out
      if (set.error && set.error.ghost_rep_indices && set.error.ghost_rep_indices.length > 0) {
        const ghostIndices = new Set(set.error.ghost_rep_indices);
        return set.reps.filter((rep, index) => !ghostIndices.has(index));
      }
      
      // No ghost reps, return all reps
      return set.reps;
    }

    // Load all users (both active and inactive for rating calculations)
    async function loadAllUsers() {
      try {
        let allUsers = [];
        
        // Load active users
        const activeUsers = await fetchUsersByActiveStatus(true);
        allUsers = allUsers.concat(activeUsers);
        
        // Load inactive users
        const inactiveUsers = await fetchUsersByActiveStatus(false);
        allUsers = allUsers.concat(inactiveUsers);
        
        console.log(`Loaded ${allUsers.length} total users (active + inactive)`);
        return allUsers;
      } catch (error) {
        console.error('Error loading users:', error);
        return [];
      }
    }

    async function fetchUsersByActiveStatus(isActive) {
      try {
        let users = [];
        let hasMore = true;
        let nextToken = null;
        const limit = 500;
        
        while (hasMore) {
          const body = {
            limit: limit,
            next_token: nextToken,
            group_id: ORG_ID,
            active: isActive
          };

          const response = await fetch('https://api.perch.fit/v2/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': AUTH_HEADER,
              'accept': 'application/json'
            },
            body: JSON.stringify(body)
          });

          if (!response.ok) {
            console.warn(`${isActive ? 'Active' : 'Inactive'} users fetch failed ${response.status}`);
            break;
          }
          
          const data = await response.json();
          const batchUsers = data.data || [];
          users = users.concat(batchUsers);
          
          if (data.truncated && data.next_token) {
            nextToken = data.next_token;
          } else {
            hasMore = false;
          }
        }
        
        return users;
      } catch (error) {
        console.error(`Error loading ${isActive ? 'active' : 'inactive'} users:`, error);
        return [];
      }
    }

    // Load exercises
    async function loadExercises() {
      try {
        const response = await fetch('https://api.perch.fit/v3/exercises', {
          headers: { 'Authorization': AUTH_HEADER, 'accept': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          const exercises = data.data || [];
          
          // Filter to only the exercises we care about
          const targetExercises = exercises.filter(ex => 
            ex.name && Object.keys(EXERCISE_CONFIG).some(targetName => 
              ex.name.toLowerCase().includes(targetName.toLowerCase())
            )
          );
          
          console.log(`Found ${targetExercises.length} target exercises for ratings`);
          return targetExercises;
        }
      } catch (error) {
        console.error('Error loading exercises:', error);
      }
      return [];
    }

    // Load sets data for rating exercises
    async function loadSetsData(exercises) {
      try {
        let allSets = [];
        const endTime = Math.floor(Date.now() / 1000);
        const beginTime = endTime - (5 * 365 * 24 * 60 * 60); // 5 years of data
        
        for (const exercise of exercises) {
          console.log(`Loading sets for ${exercise.name}...`);
          
          const sets = await fetchSetsForExercise(exercise.id, beginTime, endTime);
          const setsWithExerciseName = sets.map(set => ({
            ...set,
            exercise_name: exercise.name
          }));
          
          allSets = allSets.concat(setsWithExerciseName);
          console.log(`Loaded ${sets.length} sets for ${exercise.name}`);
        }
        
        console.log(`Total sets loaded: ${allSets.length}`);
        return allSets;
      } catch (error) {
        console.error('Error loading sets data:', error);
        return [];
      }
    }

    async function fetchSetsForExercise(exerciseId, beginTime, endTime) {
      try {
        let allSets = [];
        let nextToken = null;
        const limit = 1000;
        let hasMore = true;
        
        while (hasMore) {
          const body = {
            limit: limit,
            next_token: nextToken,
            group_id: ORG_ID,
            exercise_id: exerciseId,
            include_reps: true,
            untracked: 'EXCLUDE', // Only tracked sets
            begin_time: beginTime,
            end_time: endTime
          };
          
          const response = await fetch('https://api.perch.fit/v3/sets', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': AUTH_HEADER,
              'accept': 'application/json'
            },
            body: JSON.stringify(body)
          });
          
          if (!response.ok) {
            console.warn(`Failed to fetch sets for exercise ${exerciseId}: ${response.status}`);
            break;
          }
          
          const data = await response.json();
          const sets = data.data || [];
          allSets = allSets.concat(sets);
          
          if (data.truncated && data.next_token) {
            nextToken = data.next_token;
          } else {
            hasMore = false;
          }
        }
        
        return allSets;
      } catch (error) {
        console.error(`Error fetching sets for exercise ${exerciseId}:`, error);
        return [];
      }
    }

    // Calculate best rep metrics per athlete
    function calculateAthleteMetrics(users, sets) {
      const athleteMetrics = {};
      
      // Initialize all users
      users.forEach(user => {
        athleteMetrics[user.id] = {
          user_id: user.id,
          name: user.name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || `User ${user.id}`,
          gender: user.gender ? user.gender.toLowerCase() : 'unknown',
          active: user.active,
          lower_body_strength_metric: null, // Best weight from lower body exercises
          lower_body_power_metric: null,    // Best power from lower body exercises
          upper_body_strength_metric: null, // Best weight from bench press
          upper_body_power_metric: null     // Best power from bench press
        };
      });
      
      // Process all sets
      sets.forEach(set => {
        if (!athleteMetrics[set.user_id]) return;
        
        const athlete = athleteMetrics[set.user_id];
        const exerciseConfig = EXERCISE_CONFIG[set.exercise_name];
        if (!exerciseConfig) return;
        
        // Get only valid reps (excluding ghost reps)
        const validReps = getValidReps(set);
        if (validReps.length === 0) return;
        
        // Process each valid rep in the set
        validReps.forEach(rep => {
          if (!set.weight || set.weight <= 0) return;
          
          if (exerciseConfig.body_segment === 'LOWER') {
            // Lower body strength - track best weight
            if (!athlete.lower_body_strength_metric || set.weight > athlete.lower_body_strength_metric) {
              athlete.lower_body_strength_metric = set.weight;
            }
            
            // Lower body power - depends on movement pattern
            let power = null;
            if (exerciseConfig.movement_pattern === 'JUMP') {
              // Use peak power for jumps
              if (rep.concentric_peak_power_per_mass_z) {
                power = convertPeakPowerToWatts(rep.concentric_peak_power_per_mass_z, set.weight);
              }
            } else {
              // Use mean power for other exercises
              if (rep.concentric_mean_velocity_z) {
                power = convertMeanPowerToWatts(rep.concentric_mean_velocity_z * set.weight);
              }
            }
            
            if (power && (!athlete.lower_body_power_metric || power > athlete.lower_body_power_metric)) {
              athlete.lower_body_power_metric = power;
            }
          } else if (exerciseConfig.body_segment === 'UPPER') {
            // Upper body strength - track best weight
            if (!athlete.upper_body_strength_metric || set.weight > athlete.upper_body_strength_metric) {
              athlete.upper_body_strength_metric = set.weight;
            }
            
            // Upper body power - use mean power
            if (rep.concentric_mean_velocity_z) {
              const power = convertMeanPowerToWatts(rep.concentric_mean_velocity_z * set.weight);
              if (power && (!athlete.upper_body_power_metric || power > athlete.upper_body_power_metric)) {
                athlete.upper_body_power_metric = power;
              }
            }
          }
        });
      });
      
      return Object.values(athleteMetrics);
    }

    // Calculate ratings for all athletes
    function calculateRatings(athleteMetrics) {
      const ratings = {};
      const genders = ['male', 'female'];
      const metrics = [
        'lower_body_strength_metric',
        'lower_body_power_metric', 
        'upper_body_strength_metric',
        'upper_body_power_metric'
      ];
      
      genders.forEach(gender => {
        ratings[gender] = {};
        const genderAthletes = athleteMetrics.filter(a => a.gender === gender);
        
        metrics.forEach(metric => {
          const validAthletes = genderAthletes.filter(a => a[metric] !== null);
          if (validAthletes.length === 0) return;
          
          const values = validAthletes.map(a => a[metric]);
          const minValue = Math.min(...values);
          const maxValue = Math.max(...values);
          const range = maxValue - minValue;
          const step = range > 0 ? range / 50 : 1; // 49-99 = 50 points
          
          ratings[gender][metric] = { minValue, maxValue, step };
        });
      });
      
      // Calculate individual ratings
      const ratedAthletes = athleteMetrics.map(athlete => {
        const ratingKey = athlete.gender;
        const result = { ...athlete };
        
        metrics.forEach(metric => {
          const ratingName = metric.replace('_metric', '_rating');
          
          if (athlete[metric] !== null && ratings[ratingKey] && ratings[ratingKey][metric]) {
            const { minValue, step } = ratings[ratingKey][metric];
            const rawRating = 49 + ((athlete[metric] - minValue) / step);
            result[ratingName] = Math.max(49, Math.min(99, Math.round(rawRating)));
          } else {
            result[ratingName] = 49; // Default rating for missing data
          }
        });
        
        // Calculate overall rating (average of all ratings)
        const ratingValues = [
          result.lower_body_strength_rating,
          result.lower_body_power_rating,
          result.upper_body_strength_rating,
          result.upper_body_power_rating
        ].filter(r => r !== null && r !== undefined);
        
        result.overall_rating = ratingValues.length > 0 
          ? Math.round(ratingValues.reduce((sum, r) => sum + r, 0) / ratingValues.length)
          : 49;
        
        return result;
      });
      
      return ratedAthletes;
    }

    // UI Functions
    function switchGender(gender) {
      currentGender = gender;
      
      // Update active tab
      document.querySelectorAll('.gender-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-gender="${gender}"]`).classList.add('active');
      
      // Update athlete dropdown
      updateAthleteDropdown();
      
      // Clear current selection
      selectedAthlete = null;
      document.getElementById('ratingDisplay').style.display = 'none';
    }

    function updateAthleteDropdown() {
      const dropdown = document.getElementById('athleteSelector');
      dropdown.innerHTML = '<option value="">Select an athlete...</option>';
      
      // Only show active athletes in dropdown
      const activeAthletes = allRatings.filter(athlete => 
        athlete.active === true && athlete.gender === currentGender
      ).sort((a, b) => a.name.localeCompare(b.name));
      
      activeAthletes.forEach(athlete => {
        const option = document.createElement('option');
        option.value = athlete.user_id;
        option.textContent = athlete.name;
        dropdown.appendChild(option);
      });
      
      console.log(`Updated dropdown with ${activeAthletes.length} active ${currentGender} athletes`);
    }

    function selectAthlete() {
      const dropdown = document.getElementById('athleteSelector');
      const userId = parseInt(dropdown.value);
      
      if (!userId) {
        document.getElementById('ratingDisplay').style.display = 'none';
        return;
      }
      
      selectedAthlete = allRatings.find(athlete => athlete.user_id === userId);
      if (selectedAthlete) {
        displayAthleteRatings(selectedAthlete);
      }
    }

    function displayAthleteRatings(athlete) {
      // Show the rating display
      document.getElementById('ratingDisplay').style.display = 'block';
      
      // Update overall rating
      document.getElementById('overallScore').textContent = athlete.overall_rating;
      
      // Update individual ratings
      updateRatingCard('lowerStrength', athlete.lower_body_strength_metric ? athlete.lower_body_strength_rating : 'N/A', athlete.lower_body_strength_metric ? '' : 'No reps attempted');
      updateRatingCard('lowerPower', athlete.lower_body_power_metric ? athlete.lower_body_power_rating : 'N/A', athlete.lower_body_power_metric ? '' : 'No reps attempted');
      updateRatingCard('upperStrength', athlete.upper_body_strength_metric ? athlete.upper_body_strength_rating : 'N/A', athlete.upper_body_strength_metric ? '' : 'No reps attempted');
      updateRatingCard('upperPower', athlete.upper_body_power_metric ? athlete.upper_body_power_rating : 'N/A', athlete.upper_body_power_metric ? '' : 'No reps attempted');
    }

    function updateRatingCard(prefix, rating, details) {
      document.getElementById(`${prefix}Score`).textContent = rating;
      document.getElementById(`${prefix}Details`).textContent = details;
      
      // Update progress bar
      const percentage = ((rating - 49) / 50) * 100; // Convert 49-99 to 0-100%
      document.getElementById(`${prefix}Bar`).style.width = `${percentage}%`;
    }

    function showError(message) {
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('errorState').textContent = message;
      document.getElementById('errorState').style.display = 'block';
    }

    // Initialize the page
    async function initializePage() {
      try {
        console.log('Initializing Hornet Ratings page...');
        
        // Load all data
        console.log('Loading users...');
        allUsers = await loadAllUsers();
        
        console.log('Loading exercises...');
        allExercises = await loadExercises();
        
        console.log('Loading sets data...');
        allSets = await loadSetsData(allExercises);
        
        console.log('Calculating athlete metrics...');
        const athleteMetrics = calculateAthleteMetrics(allUsers, allSets);
        
        console.log('Calculating ratings...');
        allRatings = calculateRatings(athleteMetrics);
        
        console.log(`Calculated ratings for ${allRatings.length} athletes`);
        
        // Hide loading state
        document.getElementById('loadingState').style.display = 'none';
        
        // Update UI
        updateAthleteDropdown();
        
      } catch (error) {
        console.error('Error initializing page:', error);
        showError('Failed to load rating data. Please try again.');
      }
    }

    // Start initialization when page loads
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
