<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Athlete Progress</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Progress page styling */
    .progress-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .athlete-selector {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .athlete-dropdown {
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      border: 2px solid var(--hornet-green);
      background: white;
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      min-width: 200px;
    }

    .progress-content {
      display: none;
    }

    .progress-content.active {
      display: block;
    }

    .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .stat-card {
      background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-light);
      text-align: center;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--hornet-green);
    }

    .progress-section {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-icon {
      font-size: 1.5rem;
      margin-right: 0.75rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--hornet-green);
      margin: 0;
    }

    .exercise-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
    }

    .exercise-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border-light);
    }

    .exercise-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      font-size: 0.9rem;
    }

    .metric-label {
      color: var(--text-secondary);
    }

    .metric-value {
      font-weight: 600;
      color: var(--hornet-green);
    }

    .improvement {
      color: #28a745;
    }

    .decline {
      color: #dc3545;
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: var(--text-secondary);
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <div id="hornet-container"></div>
  
  <header class="header">
    <div class="header-content">
      <button onclick="navigateWithHornets('index.html')" class="back-button">
        <span class="back-arrow">‚Üê</span>
        <span>Back to Home</span>
      </button>
      <h1 class="page-title">üìà Athlete Progress</h1>
      <div class="hornet-logo">
        <span class="hornet-text">GoHornets</span>
      </div>
    </div>
  </header>

  <main class="progress-container">
    <div class="athlete-selector">
      <select id="athleteDropdown" class="athlete-dropdown">
        <option value="">Select an Athlete</option>
      </select>
    </div>

    <div id="progressContent" class="progress-content">
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-label">Total Workouts</div>
          <div class="stat-value" id="totalWorkouts">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Overall Rating</div>
          <div class="stat-value" id="overallRating">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Last Workout</div>
          <div class="stat-value" id="lastWorkout">--</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active Days</div>
          <div class="stat-value" id="activeDays">0</div>
        </div>
      </div>

      <div class="progress-section">
        <div class="section-header">
          <span class="section-icon">üî®</span>
          <h2 class="section-title">Strength Progress</h2>
        </div>
        <div id="strengthProgress" class="exercise-grid"></div>
      </div>

      <div class="progress-section">
        <div class="section-header">
          <span class="section-icon">‚ö°</span>
          <h2 class="section-title">Power Progress</h2>
        </div>
        <div id="powerProgress" class="exercise-grid"></div>
      </div>

      <div class="progress-section">
        <div class="section-header">
          <span class="section-icon">üöÄ</span>
          <h2 class="section-title">Jump Progress</h2>
        </div>
        <div id="jumpProgress" class="exercise-grid"></div>
      </div>
    </div>

    <div id="noData" class="no-data">
      Select an athlete to view their progress
    </div>
  </main>

  <script src="script.js"></script>
  <script>
    const AUTH_HEADER = 'Bearer 31606b711ce9ef5a7b7d887dcbe60c6601f6691d7d3b9bab3f0eeb0ab9db';
    const ORG_ID = 7617;

    const EXERCISE_CONFIG = {
      'Back Squat': { body_segment: 'LOWER', movement_pattern: 'SQUAT' },
      'Front Squat': { body_segment: 'LOWER', movement_pattern: 'SQUAT' },
      'Trap Bar Deadlift': { body_segment: 'LOWER', movement_pattern: 'DEADLIFT' },
      'Bar RDL': { body_segment: 'LOWER', movement_pattern: 'DEADLIFT' },
      'Trap Bar Jump': { body_segment: 'LOWER', movement_pattern: 'JUMP' },
      'Bench Press': { body_segment: 'UPPER', movement_pattern: 'PRESS' },
      'Vertical Jump': { body_segment: 'LOWER', movement_pattern: 'JUMP' }
    };

    let allUsers = [];
    let allExercises = {};
    let allSets = [];

    async function loadData() {
      try {
        console.log('Loading users...');
        allUsers = await fetchActiveUsers();
        allUsers.sort((a, b) => {
          const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
          const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
          return nameA.localeCompare(nameB);
        });

        console.log('Loading exercises...');
        const exercises = await fetchExercises();
        allExercises = {};
        exercises.forEach(ex => {
          allExercises[ex.id] = ex.name;
        });

        console.log('Loading sets...');
        allSets = await fetchAllSets(exercises);

        populateAthleteDropdown();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    async function fetchActiveUsers() {
      try {
        let users = [];
        let hasMore = true;
        let nextToken = null;
        const limit = 500;
        
        while (hasMore) {
          const body = {
            limit: limit,
            next_token: nextToken,
            group_id: ORG_ID,
            active: true
          };

          const response = await fetch('https://api.perch.fit/v2/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': AUTH_HEADER,
              'accept': 'application/json'
            },
            body: JSON.stringify(body)
          });

          if (!response.ok) {
            console.warn(`Active users fetch failed ${response.status}`);
            break;
          }
          
          const data = await response.json();
          const batchUsers = data.data || [];
          users = users.concat(batchUsers);
          
          if (data.truncated && data.next_token) {
            nextToken = data.next_token;
          } else {
            hasMore = false;
          }
        }
        
        console.log(`Loaded ${users.length} active users`);
        return users;
      } catch (error) {
        console.error('Error loading users:', error);
        return [];
      }
    }

    async function fetchExercises() {
      try {
        const response = await fetch('https://api.perch.fit/v3/exercises', {
          headers: { 'Authorization': AUTH_HEADER, 'accept': 'application/json' }
        });
        
        if (response.ok) {
          const data = await response.json();
          const exercises = data.data || [];
          
          const targetExercises = exercises.filter(ex => 
            ex.name && Object.keys(EXERCISE_CONFIG).some(targetName => 
              ex.name.toLowerCase().includes(targetName.toLowerCase())
            )
          );
          
          console.log(`Found ${targetExercises.length} target exercises`);
          return targetExercises;
        }
      } catch (error) {
        console.error('Error loading exercises:', error);
      }
      return [];
    }

    async function fetchAllSets(exercises) {
      try {
        let allSets = [];
        const endTime = Math.floor(Date.now() / 1000);
        const beginTime = endTime - (5 * 365 * 24 * 60 * 60); // 5 years
        
        for (const exercise of exercises) {
          console.log(`Loading sets for ${exercise.name}...`);
          const sets = await fetchSetsForExercise(exercise.id, beginTime, endTime);
          const setsWithName = sets.map(set => ({
            ...set,
            exercise_name: exercise.name
          }));
          allSets = allSets.concat(setsWithName);
        }
        
        console.log(`Total sets loaded: ${allSets.length}`);
        return allSets;
      } catch (error) {
        console.error('Error loading sets:', error);
        return [];
      }
    }

    async function fetchSetsForExercise(exerciseId, beginTime, endTime) {
      try {
        let sets = [];
        let nextToken = null;
        const limit = 1000;
        let hasMore = true;
        
        while (hasMore) {
          const body = {
            limit: limit,
            next_token: nextToken,
            group_id: ORG_ID,
            exercise_id: exerciseId,
            include_reps: true,
            untracked: 'EXCLUDE',
            begin_time: beginTime,
            end_time: endTime
          };
          
          const response = await fetch('https://api.perch.fit/v3/sets', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': AUTH_HEADER,
              'accept': 'application/json'
            },
            body: JSON.stringify(body)
          });
          
          if (!response.ok) {
            console.warn(`Failed to fetch sets for exercise ${exerciseId}`);
            break;
          }
          
          const data = await response.json();
          const batchSets = data.data || [];
          sets = sets.concat(batchSets);
          
          if (data.truncated && data.next_token) {
            nextToken = data.next_token;
          } else {
            hasMore = false;
          }
        }
        
        return sets;
      } catch (error) {
        console.error(`Error fetching sets for exercise ${exerciseId}:`, error);
        return [];
      }
    }

    function populateAthleteDropdown() {
      const dropdown = document.getElementById('athleteDropdown');
      dropdown.innerHTML = '<option value="">Select an Athlete</option>';
      
      allUsers.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        const name = user.name || `${user.first_name || ''} ${user.last_name || ''}`.trim();
        option.textContent = name;
        dropdown.appendChild(option);
      });

      dropdown.addEventListener('change', (e) => {
        const userId = parseInt(e.target.value);
        if (userId) {
          displayAthleteProgress(userId);
        } else {
          hideProgress();
        }
      });
    }

    function displayAthleteProgress(userId) {
      const athlete = allUsers.find(u => u.id === userId);
      if (!athlete) return;

      document.getElementById('progressContent').classList.add('active');
      document.getElementById('noData').style.display = 'none';

      const athleteSets = allSets.filter(set => set.user_id === userId);
      
      // Calculate overview stats
      const uniqueDates = new Set(athleteSets.map(s => new Date(s.created_at * 1000).toDateString()));
      const totalWorkouts = uniqueDates.size;
      const lastWorkout = athleteSets.length > 0 
        ? new Date(Math.max(...athleteSets.map(s => s.created_at * 1000))).toLocaleDateString()
        : '--';
      
      document.getElementById('totalWorkouts').textContent = totalWorkouts;
      document.getElementById('lastWorkout').textContent = lastWorkout;
      document.getElementById('activeDays').textContent = totalWorkouts;

      // Process exercise data
      const exerciseProgress = calculateExerciseProgress(athleteSets);
      
      // Display progress by category
      displayStrengthProgress(exerciseProgress);
      displayPowerProgress(exerciseProgress);
      displayJumpProgress(exerciseProgress);
    }

    function calculateExerciseProgress(athleteSets) {
      const progress = {};

      Object.keys(EXERCISE_CONFIG).forEach(exerciseName => {
        progress[exerciseName] = {
          strength: { current: null, best: null, first: null },
          power: { current: null, best: null, first: null },
          height: { current: null, best: null, first: null },
          dates: []
        };
      });

      athleteSets.forEach(set => {
        const exerciseName = set.exercise_name;
        if (!EXERCISE_CONFIG[exerciseName]) return;

        const setDate = new Date(set.created_at * 1000); // Convert Unix timestamp
        
        if (exerciseName === 'Vertical Jump') {
          const height = set.max_jump_height;
          if (height) {
            if (!progress[exerciseName].height.first) {
              progress[exerciseName].height.first = height;
            }
            progress[exerciseName].height.current = height;
            if (!progress[exerciseName].height.best || height > progress[exerciseName].height.best) {
              progress[exerciseName].height.best = height;
            }
            if (!progress[exerciseName].dates.find(d => d.getTime() === setDate.getTime())) {
              progress[exerciseName].dates.push(setDate);
            }
          }
        } else {
          if (!set.reps || set.reps.length === 0) return;
          
          set.reps.forEach(rep => {
            if (!set.weight || set.weight <= 0) return;
            
            // Calculate strength and power like hornet-ratings
            const strength = set.weight;
            const power = rep.concentric_mean_velocity_z ? 
              convertMeanPowerToWatts(rep.concentric_mean_velocity_z * set.weight) : null;

            if (strength) {
              if (!progress[exerciseName].strength.first) {
                progress[exerciseName].strength.first = strength;
              }
              progress[exerciseName].strength.current = strength;
              if (!progress[exerciseName].strength.best || strength > progress[exerciseName].strength.best) {
                progress[exerciseName].strength.best = strength;
              }
            }

            if (power) {
              if (!progress[exerciseName].power.first) {
                progress[exerciseName].power.first = power;
              }
              progress[exerciseName].power.current = power;
              if (!progress[exerciseName].power.best || power > progress[exerciseName].power.best) {
                progress[exerciseName].power.best = power;
              }
            }
            
            if (!progress[exerciseName].dates.find(d => d.getTime() === setDate.getTime())) {
              progress[exerciseName].dates.push(setDate);
            }
          });
        }
      });

      return progress;
    }

    // Convert mean power from (in * lbs / s) to watts
    function convertMeanPowerToWatts(meanPowerInLbsInS) {
      if (meanPowerInLbsInS == null) return null;
      const M_PER_IN = 0.0254;
      const N_PER_LBS = 4.44822;
      return M_PER_IN * N_PER_LBS * meanPowerInLbsInS;
    }

    function displayStrengthProgress(progress) {
      const container = document.getElementById('strengthProgress');
      container.innerHTML = '';

      const strengthExercises = ['Back Squat', 'Front Squat', 'Trap Bar Deadlift', 'Bar RDL', 'Bench Press'];
      
      strengthExercises.forEach(exerciseName => {
        const data = progress[exerciseName];
        if (!data.strength.best) return;

        const improvement = data.strength.first 
          ? ((data.strength.best - data.strength.first) / data.strength.first * 100).toFixed(1)
          : 0;

        const card = document.createElement('div');
        card.className = 'exercise-card';
        card.innerHTML = `
          <div class="exercise-name">${exerciseName}</div>
          <div class="metric-row">
            <span class="metric-label">Best Strength:</span>
            <span class="metric-value">${data.strength.best.toFixed(2)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Current:</span>
            <span class="metric-value">${data.strength.current.toFixed(2)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Improvement:</span>
            <span class="metric-value ${improvement > 0 ? 'improvement' : improvement < 0 ? 'decline' : ''}">${improvement > 0 ? '+' : ''}${improvement}%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Sessions:</span>
            <span class="metric-value">${data.dates.length}</span>
          </div>
        `;
        container.appendChild(card);
      });

      if (container.children.length === 0) {
        container.innerHTML = '<div class="no-data">No strength data available</div>';
      }
    }

    function displayPowerProgress(progress) {
      const container = document.getElementById('powerProgress');
      container.innerHTML = '';

      const powerExercises = ['Back Squat', 'Front Squat', 'Trap Bar Deadlift', 'Bar RDL', 'Trap Bar Jump', 'Bench Press'];
      
      powerExercises.forEach(exerciseName => {
        const data = progress[exerciseName];
        if (!data.power.best) return;

        const improvement = data.power.first 
          ? ((data.power.best - data.power.first) / data.power.first * 100).toFixed(1)
          : 0;

        const card = document.createElement('div');
        card.className = 'exercise-card';
        card.innerHTML = `
          <div class="exercise-name">${exerciseName}</div>
          <div class="metric-row">
            <span class="metric-label">Best Power:</span>
            <span class="metric-value">${data.power.best.toFixed(2)} W</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Current:</span>
            <span class="metric-value">${data.power.current.toFixed(2)} W</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Improvement:</span>
            <span class="metric-value ${improvement > 0 ? 'improvement' : improvement < 0 ? 'decline' : ''}">${improvement > 0 ? '+' : ''}${improvement}%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Sessions:</span>
            <span class="metric-value">${data.dates.length}</span>
          </div>
        `;
        container.appendChild(card);
      });

      if (container.children.length === 0) {
        container.innerHTML = '<div class="no-data">No power data available</div>';
      }
    }

    function displayJumpProgress(progress) {
      const container = document.getElementById('jumpProgress');
      container.innerHTML = '';

      const data = progress['Vertical Jump'];
      if (data.height.best) {
        const improvement = data.height.first 
          ? ((data.height.best - data.height.first) / data.height.first * 100).toFixed(1)
          : 0;

        const card = document.createElement('div');
        card.className = 'exercise-card';
        card.innerHTML = `
          <div class="exercise-name">Vertical Jump</div>
          <div class="metric-row">
            <span class="metric-label">Best Height:</span>
            <span class="metric-value">${data.height.best.toFixed(2)} in</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Current:</span>
            <span class="metric-value">${data.height.current.toFixed(2)} in</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Improvement:</span>
            <span class="metric-value ${improvement > 0 ? 'improvement' : improvement < 0 ? 'decline' : ''}">${improvement > 0 ? '+' : ''}${improvement}%</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Sessions:</span>
            <span class="metric-value">${data.dates.length}</span>
          </div>
        `;
        container.appendChild(card);
      } else {
        container.innerHTML = '<div class="no-data">No jump data available</div>';
      }
    }

    function hideProgress() {
      document.getElementById('progressContent').classList.remove('active');
      document.getElementById('noData').style.display = 'block';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html>
