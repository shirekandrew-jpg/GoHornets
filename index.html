<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Go Hornets</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body class="login-page">
  <div class="login-container">
    <div class="login-header">
      <h1>üêù Go Hornets</h1>
      <p>Sports Performance Portal</p>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" id="email" required placeholder="your.email@example.com" autocomplete="email">
      </div>

      <div class="form-group">
        <label for="password">Password</label>
        <input type="password" id="password" required placeholder="Enter your password" autocomplete="current-password">
      </div>

      <div class="forgot-password">
        <a href="#" onclick="forgotPassword(); return false;">Forgot password?</a>
      </div>

      <button type="submit" class="login-button">
        Log In
      </button>
    </form>

  </div>

  <script src="auth.js"></script>
  <script>
    // Auto-create admin account if no accounts exist
    async function initializeAdminAccount() {
      const credentials = JSON.parse(localStorage.getItem('athlete_credentials') || '[]');
      
      // If no accounts exist, create default admin
      if (credentials.length === 0) {
        const password = 'SCDpower!1';
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        const adminAccount = {
          id: null,
          firstName: 'Shirek',
          lastName: 'Espinoza Andrew',
          email: 'aespinoza@savcds.org',
          passwordHash: passwordHash,
          inviteToken: null,
          admin: true,
          active: true,
          createdAt: Date.now(),
          setupCompletedAt: Date.now()
        };

        credentials.push(adminAccount);
        localStorage.setItem('athlete_credentials', JSON.stringify(credentials));
        console.log('Admin account created automatically');
      }
    }

    // Initialize admin account on page load
    initializeAdminAccount();

    // Check if already logged in
    if (isAthleteLoggedIn()) {
      window.location.href = 'dashboard.html';
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value.toLowerCase().trim();
      const password = document.getElementById('password').value;
      const errorMsg = document.getElementById('errorMessage');

      // Load credentials
      const credentials = JSON.parse(localStorage.getItem('athlete_credentials') || '[]');
      
      // Find athlete by email
      const athlete = credentials.find(a => a.email.toLowerCase() === email);

      if (!athlete) {
        showError('Invalid email or password');
        return;
      }

      if (!athlete.passwordHash) {
        showError('Account not set up yet. Please check your email for the setup link.');
        return;
      }

      // Verify password
      const passwordHash = await hashPassword(password);

      if (passwordHash !== athlete.passwordHash) {
        showError('Invalid email or password');
        return;
      }

      // Create session
      const session = {
        id: athlete.id,
        firstName: athlete.firstName,
        lastName: athlete.lastName,
        email: athlete.email,
        isAdmin: athlete.admin || false,
        timestamp: Date.now(),
        expiresAt: Date.now() + (24 * 60 * 60 * 1000) // 24 hours
      };

      localStorage.setItem('hornet_athlete_session', JSON.stringify(session));

      // Redirect to dashboard
      window.location.href = 'dashboard.html';
    });

    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }

    function forgotPassword() {
      alert('Please contact your coach to reset your password.');
    }

    // Clear any error when user starts typing
    document.getElementById('email').addEventListener('input', () => {
      document.getElementById('errorMessage').classList.remove('visible');
    });

    document.getElementById('password').addEventListener('input', () => {
      document.getElementById('errorMessage').classList.remove('visible');
    });
  </script>
</body>
</html>
